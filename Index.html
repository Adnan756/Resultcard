<!DOCTYPE html>
<html lang="ur" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø±Ø²Ù„Ù¹ Ú©Ø§Ø±Úˆ Ø¬Ù†Ø±ÛŒÙ¹Ø±</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, query, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Firebase variables (provided by Canvas environment)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null; // Corrected line

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        window.db = getFirestore(app); // Make db globally accessible
        window.auth = getAuth(app); // Make auth globally accessible
        window.currentUserId = null; // To store the current user's ID

        // Make Firestore functions globally accessible
        window.collection = collection;
        window.addDoc = addDoc;
        window.getDocs = getDocs;
        window.query = query;
        window.where = where;


        // Authenticate user
        onAuthStateChanged(window.auth, async (user) => {
            if (user) {
                window.currentUserId = user.uid;
                console.log("Firebase authenticated. User ID:", user.uid);
            } else {
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(window.auth, initialAuthToken);
                        window.currentUserId = window.auth.currentUser.uid;
                        console.log("Signed in with custom token. User ID:", window.currentUserId);
                    } else {
                        await signInAnonymously(window.auth);
                        window.currentUserId = window.auth.currentUser.uid;
                        console.log("Signed in anonymously. User ID:", window.currentUserId);
                    }
                } catch (error) {
                    console.error("Firebase authentication error:", error);
                    showMessage('ÙØ§Ø¦Ø± Ø¨ÛŒØ³ Ú©ÛŒ ØªØµØ¯ÛŒÙ‚ Ù…ÛŒÚº Ø®Ø±Ø§Ø¨ÛŒ Ù¾ÛŒØ´ Ø¢Ø¦ÛŒÛ”', 'error');
                }
            }
        });
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Nastaliq+Urdu:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* General Body Styling */
        body {
            font-family: 'Noto Nastaliq Urdu', serif;
            direction: rtl;
            background-color: #e0f7fa; /* Light Teal Background */
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            line-height: 1.6;
            color: #37474f; /* Dark Gray Text */
        }

        /* Container for the form */
        .container {
            background-color: #fff;
            padding: 30px;
            border-radius: 15px;
            max-width: 700px;
            width: 100%;
            box-shadow: 0 8px 24px rgba(0,0,0,0.15); /* Enhanced shadow */
            box-sizing: border-box; /* Include padding in width */
        }

        /* Heading Style */
        h1 {
            text-align: center;
            color: #00897b; /* Teal Primary Color */
            margin-bottom: 30px;
            font-size: 2.2em; /* Larger heading */
            font-weight: 700;
        }

        /* Label Styling */
        label {
            display: block;
            margin-top: 15px;
            font-weight: bold;
            color: #263238; /* Even darker gray for labels */
            font-size: 1.1em;
        }

        /* Input Field Styling */
        input[type="text"],
        input[type="number"],
        textarea {
            margin-top: 8px;
            padding: 12px;
            width: calc(100% - 24px); /* Account for padding */
            border-radius: 8px;
            border: 1px solid #80cbc4; /* Medium Teal Border */
            font-size: 1.05em;
            box-sizing: border-box;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }

        input[type="text"]:focus,
        input[type="number"]:focus,
        textarea:focus {
            border-color: #00897b; /* Darker teal on focus */
            box-shadow: 0 0 0 3px rgba(0, 137, 123, 0.2); /* Focus ring */
            outline: none;
        }

        textarea {
            resize: vertical; /* Allow vertical resizing */
            min-height: 80px; /* Minimum height for textarea */
        }

        /* Button Styling */
        button {
            margin-top: 25px;
            padding: 12px 25px;
            font-size: 1.1em;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
            font-weight: bold;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.2);
        }

        /* Specific Button Colors */
        #step1 button {
            background-color: #1e88e5; /* Blue */
            color: white;
        }
        #step1 button:hover {
            background-color: #1565c0;
        }

        #step2 .button-group button {
            margin-right: 10px; /* Spacing between buttons */
            margin-left: 10px; /* Spacing between buttons */
        }
        #step2 .button-group button.clear-button { /* New Clear Button */
            background-color: #607d8b; /* Grey */
            color: white;
        }
        #step2 .button-group button.clear-button:hover {
            background-color: #455a64;
        }
        #step2 .button-group button:first-of-type { /* Add Subject */
            background-color: #43a047; /* Green */
            color: white;
        }
        #step2 .button-group button:first-of-type:hover {
            background-color: #2e7d32;
        }
        #step2 .button-group button:nth-of-type(2) { /* Generate Remarks */
            background-color: #ff9800; /* Orange */
            color: white;
        }
        #step2 .button-group button:nth-of-type(2):hover {
            background-color: #f57c00;
        }
        #step2 .button-group button:nth-of-type(3) { /* Generate PDF */
            background-color: #1e88e5; /* Blue */
            color: white;
        }
        #step2 .button-group button:nth-of-type(3):hover {
            background-color: #1565c0;
        }
        #step2 .button-group button.share-button { /* Share on WhatsApp */
            background-color: #25d366; /* WhatsApp Green */
            color: white;
        }
        #step2 .button-group button.share-button:hover {
            background-color: #1da851;
        }
        #step2 .button-group button.excel-button { /* Download Excel */
            background-color: #107c41; /* Dark Green for Excel */
            color: white;
        }
        #step2 .button-group button.excel-button:hover {
            background-color: #0b5e2f;
        }
        #step2 .button-group button:last-of-type { /* Back button */
            background-color: #e53935; /* Red */
            color: white;
        }
        #step2 .button-group button:last-of-type:hover {
            background-color: #b71c1c;
        }

        /* Subject Row Layout */
        .subject-row {
            margin-top: 15px;
            display: grid;
            grid-template-columns: 3fr 1.2fr 1.2fr 0.5fr; /* Adjusted column widths */
            gap: 10px;
            align-items: center;
        }
        .subject-row input {
            width: 100%; /* Ensure inputs fill their grid cell */
            margin-top: 0; /* Remove extra margin from general input rule */
        }

        /* Subject Heading */
        h3 {
            color: #00897b;
            margin-top: 25px;
            margin-bottom: 15px;
            text-align: center;
            font-size: 1.5em;
            border-bottom: 2px solid #b2dfdb; /* Underline effect */
            padding-bottom: 5px;
            display: block; /* Ensure it takes full width */
        }

        /* Remove Subject Button */
        .remove-subject {
            background: none;
            border: none;
            color: #e53935; /* Red for delete */
            font-size: 1.8em; /* Larger 'x' */
            cursor: pointer;
            padding: 5px;
            outline: none;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%; /* Align vertically in grid */
            box-shadow: none; /* No shadow for this button */
        }
        .remove-subject:hover {
            color: #b71c1c;
            transform: scale(1.1); /* Slight grow on hover */
            box-shadow: none;
        }

        /* Centering for buttons */
        .button-group {
            text-align: center;
            margin-top: 30px;
        }

        /* Message Box Styling */
        #messageBox {
            padding: 10px;
            margin-top: 15px;
            border-radius: 8px;
            text-align: center;
            font-weight: bold;
            display: none; /* Hidden by default */
        }
        #loadingIndicator {
            text-align: center;
            margin-top: 15px;
            color: #00897b;
            font-weight: bold;
            display: none; /* Hidden by default */
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .container {
                padding: 20px;
                margin: 10px;
            }
            h1 {
                font-size: 1.8em;
            }
            .button-group button {
                width: 100%;
                margin-top: 15px;
                margin-right: 0 !important; /* Override inline style for step2 buttons */
                margin-left: 0 !important;
            }
            .subject-row {
                grid-template-columns: 1fr; /* Stack inputs on small screens */
            }
            .subject-row input {
                width: 100%;
            }
            .remove-subject {
                width: 100%;
                margin-top: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Ø³Ú©ÙˆÙ„ Ø±Ø²Ù„Ù¹ Ú©Ø§Ø±Úˆ Ø¬Ù†Ø±ÛŒÙ¹Ø±</h1>

        <div id="step1">
            <label for="schoolName">Ø³Ú©ÙˆÙ„ Ú©Ø§ Ù†Ø§Ù…:</label>
            <input type="text" id="schoolName" placeholder="Ù…Ø«Ù„Ø§Ù‹ØŒ Ø§Ù„Ø­Ù…Ø±Ø§Ø¡ Ø³Ú©ÙˆÙ„" />

            <label for="className">Ú©Ù„Ø§Ø³ Ú©Ø§ Ù†Ø§Ù…:</label>
            <input type="text" id="className" placeholder="Ù…Ø«Ù„Ø§Ù‹ØŒ Ø¯Ø³ÙˆÛŒÚº Ø¬Ù…Ø§Ø¹Øª" />

            <label for="classSection">Ú©Ù„Ø§Ø³ Ø³ÛŒÚ©Ø´Ù†:</label>
            <input type="text" id="classSection" placeholder="Ù…Ø«Ù„Ø§Ù‹ØŒ Ø³ÛŒÚ©Ø´Ù† Ø§Ù„Ù" />

            <label for="classIncharge">Ú©Ù„Ø§Ø³ Ø§Ù†Ú†Ø§Ø±Ø¬ Ú©Ø§ Ù†Ø§Ù…:</label>
            <input type="text" id="classIncharge" placeholder="Ù…Ø«Ù„Ø§Ù‹ØŒ Ø§Ø³ØªØ§Ø¯ Ø§Ø­Ù…Ø¯" />

            <div class="button-group">
                <button onclick="goToStep2()">Ø§Ú¯Ù„Ø§ â¡ï¸</button>
            </div>
        </div>

        <div id="step2" style="display:none;">
            <label for="studentName">Ø·Ø§Ù„Ø¨ Ø¹Ù„Ù… Ú©Ø§ Ù†Ø§Ù…:</label>
            <input type="text" id="studentName" placeholder="Ù…Ø«Ù„Ø§Ù‹ØŒ Ù…Ø­Ù…Ø¯ Ø¹Ù„ÛŒ" />

            <label for="rollNumber">Ø±ÙˆÙ„ Ù†Ù…Ø¨Ø±:</label>
            <input type="text" id="rollNumber" placeholder="Ù…Ø«Ù„Ø§Ù‹ØŒ 12345" />

            <h3 id="subjects-heading" style="display:none;">Ù…Ø¶Ø§Ù…ÛŒÙ† Ú©ÛŒ ØªÙØµÛŒÙ„:</h3>
            <div id="subjects">
                </div>

            <label for="teacherRemarks">Ø§Ø³ØªØ§Ø¯ Ú©Û’ Ø±ÛŒÙ…Ø§Ø±Ú©Ø³:</label>
            <textarea id="teacherRemarks" rows="4" placeholder="ÛŒÛØ§Úº Ø§Ø³ØªØ§Ø¯ Ú©Û’ Ø±ÛŒÙ…Ø§Ø±Ú©Ø³ Ø¯Ú©Ú¾Ø§Ø¦Û’ Ø¬Ø§Ø¦ÛŒÚº Ú¯Û’..."></textarea>

            <div class="button-group">
                <button onclick="addSubject()">+ Ù…Ø¶Ù…ÙˆÙ† Ø´Ø§Ù…Ù„ Ú©Ø±ÛŒÚº</button>
                <button onclick="generateRemarks()">âœ¨ Ø±ÛŒÙ…Ø§Ø±Ú©Ø³ Ø¨Ù†Ø§Ø¦ÛŒÚº</button>
                <button onclick="generatePDF()">ğŸ“„ Ù¾ÛŒ ÚˆÛŒ Ø§ÛŒÙ Ø¨Ù†Ø§Ø¦ÛŒÚº</button>
                <button class="share-button" onclick="shareOnWhatsApp()">WhatsApp Ù¾Ø± Ø´ÛŒØ¦Ø± Ú©Ø±ÛŒÚº</button>
                <button class="excel-button" onclick="downloadClassDataAsExcel()">ğŸ“Š Excel Ù…ÛŒÚº ÚˆØ§Ø¦ÙˆÙ† Ù„ÙˆÚˆ Ú©Ø±ÛŒÚº</button>
                <button class="clear-button" onclick="clearStudentData()">Ù†ÛŒØ§ Ø±Ø²Ù„Ù¹ Ú©Ø§Ø±Úˆ</button>
                <button onclick="goToStep1()">â¬…ï¸ ÙˆØ§Ù¾Ø³</button>
            </div>
            <div id="loadingIndicator">
                Ø±ÛŒÙ…Ø§Ø±Ú©Ø³ ØªÛŒØ§Ø± Ú©ÛŒÛ’ Ø¬Ø§ Ø±ÛÛ’ ÛÛŒÚº...
            </div>
            <div id="messageBox"></div>
        </div>
    </div>

    <script>
        // Global Firebase instances (initialized in the <script type="module"> block)
        let db;
        let auth;
        let currentUserId; // This will be set after Firebase auth state changes

        // Array to keep track of subject input elements' IDs
        let subjectsData = [];
        const subjectsContainer = document.getElementById('subjects');
        const subjectsHeading = document.getElementById('subjects-heading');

        // Default subject names to pre-fill
        const defaultSubjectNames = ["Ø§Ø±Ø¯Ùˆ", "Ø§Ù†Ú¯Ø±ÛŒØ²ÛŒ", "Ø±ÛŒØ§Ø¶ÛŒ", "Ø³Ø§Ø¦Ù†Ø³", "Ø§Ø³Ù„Ø§Ù…ÛŒØ§Øª"];

        /**
         * Displays a message to the user in a styled box.
         * @param {string} message - The message to display.
         * @param {string} type - The type of message ('info', 'warning', 'error', 'success').
         */
        function showMessage(message, type = 'info') {
            const messageBox = document.getElementById('messageBox');
            messageBox.textContent = message;
            messageBox.style.display = 'block';
            if (type === 'warning') {
                messageBox.style.backgroundColor = '#ffe0b2'; /* Light orange */
                messageBox.style.color = '#e65100'; /* Dark orange */
            } else if (type === 'error') {
                messageBox.style.backgroundColor = '#ffcdd2'; /* Light red */
                messageBox.style.color = '#d32f2f'; /* Dark red */
            } else if (type === 'success') {
                messageBox.style.backgroundColor = '#c8e6c9'; /* Light green */
                messageBox.style.color = '#388e3c'; /* Dark green */
            } else { /* Default info */
                messageBox.style.backgroundColor = '#bbdefb'; /* Light blue */
                messageBox.style.color = '#1976d2'; /* Dark blue */
            }
            // Hide the message after 5 seconds
            setTimeout(() => {
                messageBox.style.display = 'none';
            }, 5000);
        }

        /**
         * Navigates from Step 1 to Step 2 of the form.
         * Adds a default subject row if none exist.
         */
        function goToStep2() {
            // Basic validation for Step 1 fields
            const schoolName = document.getElementById('schoolName').value.trim();
            const className = document.getElementById('className').value.trim();
            const classSection = document.getElementById('classSection').value.trim();
            const classIncharge = document.getElementById('classIncharge').value.trim();

            if (!schoolName || !className || !classSection || !classIncharge) {
                showMessage('Ø¨Ø±Ø§Û Ú©Ø±Ù… ØªÙ…Ø§Ù… Ø³Ú©ÙˆÙ„ Ú©ÛŒ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù¾ÙØ± Ú©Ø±ÛŒÚºÛ”', 'warning');
                return;
            }

            document.getElementById('step1').style.display = 'none';
            document.getElementById('step2').style.display = 'block';
            // Add default subjects if no subjects have been added yet
            if (subjectsData.length === 0) {
                defaultSubjectNames.forEach(name => addSubject(name, 100)); // Pre-fill with default names and 100 total marks
            }
            // Hide message box and loading indicator when changing steps
            document.getElementById('messageBox').style.display = 'none';
            document.getElementById('loadingIndicator').style.display = 'none';
        }

        /**
         * Navigates from Step 2 back to Step 1.
         * Clears subject data for a fresh start on Step 2 next time.
         */
        function goToStep1() {
            document.getElementById('step2').style.display = 'none';
            document.getElementById('step1').style.display = 'block';
            // Clear all student-specific data
            clearStudentData(false); // Do not re-add default subjects here
            // Hide message box and loading indicator when changing steps
            document.getElementById('messageBox').style.display = 'none';
            document.getElementById('loadingIndicator').style.display = 'none';
        }

        /**
         * Clears all student-specific data on Step 2 and prepares for a new student.
         * @param {boolean} reAddDefaults - Whether to re-add default subjects after clearing.
         */
        function clearStudentData(reAddDefaults = true) {
            document.getElementById('studentName').value = '';
            document.getElementById('rollNumber').value = '';
            document.getElementById('teacherRemarks').value = '';
            subjectsContainer.innerHTML = ''; // Clear all subject rows
            subjectsData = []; // Reset the subjectsData array
            subjectsHeading.style.display = 'none'; // Hide the heading

            if (reAddDefaults) {
                defaultSubjectNames.forEach(name => addSubject(name, 100)); // Re-fill with default names and 100 total marks
            }
            showMessage('Ù†Ø¦Û’ Ø·Ø§Ù„Ø¨ Ø¹Ù„Ù… Ú©Û’ Ù„ÛŒÛ’ ÙØ§Ø±Ù… ØµØ§Ù Ú©Ø± Ø¯ÛŒØ§ Ú¯ÛŒØ§ ÛÛ’Û”', 'info');
        }

        /**
         * Adds a new subject input row to the form.
         * @param {string} [defaultName=''] - Optional default name for the subject.
         * @param {number} [defaultTotal=0] - Optional default total marks for the subject.
         */
        function addSubject(defaultName = '', defaultTotal = '') {
            subjectsHeading.style.display = 'block'; // Show the heading when subjects are present

            // Create a unique index for the new subject row
            const newIndex = subjectsData.length > 0 ? Math.max(...subjectsData) + 1 : 0;
            subjectsData.push(newIndex); // Add the new index to our tracking array

            const div = document.createElement('div');
            div.className = 'subject-row';
            div.setAttribute('data-index', newIndex); // Store the unique index on the div

            div.innerHTML = `
                <input type="text" placeholder="Ù…Ø¶Ù…ÙˆÙ† Ú©Ø§ Ù†Ø§Ù…" id="subject_name_${newIndex}" value="${defaultName}" />
                <input type="number" placeholder="Ú©Ù„ Ù†Ù…Ø¨Ø±" id="subject_total_${newIndex}" min="0" value="${defaultTotal}" />
                <input type="number" placeholder="Ø­Ø§ØµÙ„ Ú©Ø±Ø¯Û Ù†Ù…Ø¨Ø±" id="subject_obtained_${newIndex}" min="0" />
                <button class="remove-subject" onclick="removeSubject(${newIndex})">Ã—</button>
            `;
            subjectsContainer.appendChild(div);
        }

        /**
         * Removes a specific subject input row from the form.
         * @param {number} indexToRemove - The unique index of the subject row to remove.
         */
        function removeSubject(indexToRemove) {
            const rowToRemove = subjectsContainer.querySelector(`.subject-row[data-index="${indexToRemove}"]`);
            if (rowToRemove) {
                subjectsContainer.removeChild(rowToRemove);
                // Remove the index from the subjectsData array
                subjectsData = subjectsData.filter(index => index !== indexToRemove);

                // Hide the heading if no subjects are left
                if (subjectsData.length === 0) {
                    subjectsHeading.style.display = 'none';
                }
            }
        }

        /**
         * Generates academic remarks using the Gemini API based on student performance.
         */
        async function generateRemarks() {
            const studentName = document.getElementById('studentName').value.trim();
            const className = document.getElementById('className').value.trim();
            const schoolName = document.getElementById('schoolName').value.trim();
            const teacherRemarksTextArea = document.getElementById('teacherRemarks');
            const loadingIndicator = document.getElementById('loadingIndicator');
            const generateRemarksBtn = document.querySelector('button[onclick="generateRemarks()"]');

            if (!studentName || !className || subjectsData.length === 0) {
                showMessage('Ø¨Ø±Ø§Û Ú©Ø±Ù… Ø·Ø§Ù„Ø¨ Ø¹Ù„Ù… Ú©Ø§ Ù†Ø§Ù…ØŒ Ú©Ù„Ø§Ø³ØŒ Ø§ÙˆØ± Ù…Ø¶Ø§Ù…ÛŒÙ† Ú©ÛŒ ØªÙØµÛŒÙ„Ø§Øª Ù…Ú©Ù…Ù„ Ú©Ø±ÛŒÚºÛ”', 'warning');
                return;
            }

            loadingIndicator.style.display = 'block';
            generateRemarksBtn.disabled = true;
            teacherRemarksTextArea.value = ''; // Clear previous remarks
            showMessage('', 'info'); // Clear any previous messages

            let subjectDetails = [];
            let totalMarks = 0;
            let obtainedMarks = 0;

            // Gather subject data for the prompt
            subjectsData.forEach(index => {
                const subjectName = document.getElementById(`subject_name_${index}`).value.trim();
                const total = parseInt(document.getElementById(`subject_total_${index}`).value) || 0;
                const obtained = parseInt(document.getElementById(`subject_obtained_${index}`).value) || 0;

                if (subjectName && !isNaN(total) && !isNaN(obtained) && total >= 0 && obtained >= 0) {
                    subjectDetails.push(`${subjectName}: ${obtained}/${total}`);
                    totalMarks += total;
                    obtainedMarks += obtained;
                }
            });

            const percentage = totalMarks > 0 ? ((obtainedMarks / totalMarks) * 100).toFixed(2) : 0;
            const result = percentage >= 40 ? 'Ù¾Ø§Ø³' : 'ÙÛŒÙ„';

            // Construct the prompt for the LLM
            const prompt = `Generate a concise (max 60 words) and appropriate academic remark in Urdu for a student with the following performance on their school result card. The remark should be encouraging if the student passed, and constructive with suggestions for improvement if the student failed. Do not mention specific marks or percentages, focus on general performance and effort.

            Student Name: ${studentName}
            Class: ${className}
            School: ${schoolName}
            Subject Performance: ${subjectDetails.join(', ')}
            Overall Result: ${result} (Percentage: ${percentage}%)
            `;

            try {
                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                const payload = { contents: chatHistory };
                const apiKey = ""; // Leave as empty string, Canvas will provide it
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const resultData = await response.json();

                if (resultData.candidates && resultData.candidates.length > 0 &&
                    resultData.candidates[0].content && resultData.candidates[0].content.parts &&
                    resultData.candidates[0].content.parts.length > 0) {
                    const generatedText = resultData.candidates[0].content.parts[0].text;
                    teacherRemarksTextArea.value = generatedText;
                    showMessage('Ø±ÛŒÙ…Ø§Ø±Ú©Ø³ Ú©Ø§Ù…ÛŒØ§Ø¨ÛŒ Ø³Û’ ØªÛŒØ§Ø± ÛÙˆ Ú¯Ø¦Û’ ÛÛŒÚºÛ”', 'success');
                } else {
                    console.error('Gemini API response structure unexpected:', resultData);
                    showMessage('Ø±ÛŒÙ…Ø§Ø±Ú©Ø³ ØªÛŒØ§Ø± Ú©Ø±Ù†Û’ Ù…ÛŒÚº Ù†Ø§Ú©Ø§Ù…ÛŒ: ØºÛŒØ± Ù…ØªÙˆÙ‚Ø¹ Ø¬ÙˆØ§Ø¨Û”', 'error');
                }
            } catch (error) {
                console.error('Error generating remarks:', error);
                showMessage('Ø±ÛŒÙ…Ø§Ø±Ú©Ø³ ØªÛŒØ§Ø± Ú©Ø±Ù†Û’ Ù…ÛŒÚº Ø®Ø±Ø§Ø¨ÛŒ Ù¾ÛŒØ´ Ø¢Ø¦ÛŒÛ”', 'error');
            } finally {
                loadingIndicator.style.display = 'none';
                generateRemarksBtn.disabled = false;
            }
        }

        /**
         * Saves the current student's result data to Firestore.
         */
        async function saveStudentResult() {
            if (!window.db || !window.currentUserId) {
                console.error("Firestore or User ID not available.");
                showMessage('ÚˆÛŒÙ¹Ø§ Ù…Ø­ÙÙˆØ¸ Ú©Ø±Ù†Û’ Ú©Û’ Ù„ÛŒÛ’ ÙØ§Ø¦Ø± Ø¨ÛŒØ³ ØªÛŒØ§Ø± Ù†ÛÛŒÚº ÛÛ’Û”', 'error');
                return;
            }

            const schoolName = document.getElementById('schoolName').value.trim();
            const className = document.getElementById('className').value.trim();
            const classSection = document.getElementById('classSection').value.trim();
            const classIncharge = document.getElementById('classIncharge').value.trim();
            const studentName = document.getElementById('studentName').value.trim();
            const rollNumber = document.getElementById('rollNumber').value.trim();
            const teacherRemarks = document.getElementById('teacherRemarks').value.trim();

            let subjectsArray = [];
            let totalMarks = 0;
            let obtainedMarks = 0;

            subjectsData.forEach(index => {
                const subjectName = document.getElementById(`subject_name_${index}`).value.trim();
                const total = parseInt(document.getElementById(`subject_total_${index}`).value) || 0;
                const obtained = parseInt(document.getElementById(`subject_obtained_${index}`).value) || 0;

                if (subjectName && !isNaN(total) && !isNaN(obtained) && total >= 0 && obtained >= 0) {
                    subjectsArray.push({ name: subjectName, total: total, obtained: obtained });
                    totalMarks += total;
                    obtainedMarks += obtained;
                }
            });

            const percentage = totalMarks > 0 ? ((obtainedMarks / totalMarks) * 100).toFixed(2) : 0;
            const result = percentage >= 40 ? 'Ù¾Ø§Ø³' : 'ÙÛŒÙ„';

            const studentResultData = {
                schoolName: schoolName,
                className: className,
                classSection: classSection,
                classIncharge: classIncharge,
                studentName: studentName,
                rollNumber: rollNumber,
                subjects: subjectsArray,
                totalMarks: totalMarks,
                obtainedMarks: obtainedMarks,
                percentage: percentage,
                result: result,
                teacherRemarks: teacherRemarks,
                timestamp: new Date()
            };

            try {
                const collectionPath = `artifacts/${window.__app_id}/users/${window.currentUserId}/class_results`;
                await window.addDoc(window.collection(window.db, collectionPath), studentResultData);
                console.log("Student data saved to Firestore successfully!");
                showMessage('Ø·Ø§Ù„Ø¨ Ø¹Ù„Ù… Ú©Ø§ ÚˆÛŒÙ¹Ø§ Ú©Ø§Ù…ÛŒØ§Ø¨ÛŒ Ø³Û’ Ù…Ø­ÙÙˆØ¸ ÛÙˆ Ú¯ÛŒØ§ ÛÛ’Û”', 'success');
            } catch (error) {
                console.error("Error saving student data to Firestore:", error);
                showMessage('Ø·Ø§Ù„Ø¨ Ø¹Ù„Ù… Ú©Ø§ ÚˆÛŒÙ¹Ø§ Ù…Ø­ÙÙˆØ¸ Ú©Ø±Ù†Û’ Ù…ÛŒÚº Ø®Ø±Ø§Ø¨ÛŒ Ù¾ÛŒØ´ Ø¢Ø¦ÛŒÛ”', 'error');
            }
        }

        /**
         * Generates the PDF result card by converting HTML content to an image.
         */
        async function generatePDF() {
            // First, save the student's data to Firestore
            await saveStudentResult();

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4'); // Portrait, millimeters, A4 size

            // Hide buttons and elements not meant for the PDF capture
            const buttons = document.querySelectorAll('.button-group button');
            buttons.forEach(btn => btn.style.display = 'none');
            const messageBox = document.getElementById('messageBox');
            messageBox.style.display = 'none';
            const loadingIndicator = document.getElementById('loadingIndicator');
            loadingIndicator.style.display = 'none';

            // Declare pdfContentDiv outside the try block
            let pdfContentDiv = null; 

            // Get the main container element to convert to canvas
            const schoolName = document.getElementById('schoolName').value.trim();
            const className = document.getElementById('className').value.trim();
            const classSection = document.getElementById('classSection').value.trim();
            const classIncharge = document.getElementById('classIncharge').value.trim();
            const studentName = document.getElementById('studentName').value.trim();
            const rollNumber = document.getElementById('rollNumber').value.trim();
            const teacherRemarks = document.getElementById('teacherRemarks').value.trim();

            // Basic validation for Step 2 fields
            if (!studentName || !rollNumber || subjectsData.length === 0) {
                showMessage('Ø¨Ø±Ø§Û Ú©Ø±Ù… Ø·Ø§Ù„Ø¨ Ø¹Ù„Ù… Ú©ÛŒ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§ÙˆØ± Ú©Ù… Ø§Ø² Ú©Ù… Ø§ÛŒÚ© Ù…Ø¶Ù…ÙˆÙ† Ú©ÛŒ ØªÙØµÛŒÙ„ Ø¯Ø±Ø¬ Ú©Ø±ÛŒÚºÛ”', 'warning');
                // Restore buttons and messages
                buttons.forEach(btn => btn.style.display = 'inline-block');
                return;
            }

            try {
                // Temporarily create a div to hold all content for PDF, including step1 data
                pdfContentDiv = document.createElement('div');
                pdfContentDiv.style.fontFamily = 'Noto Nastaliq Urdu, serif';
                pdfContentDiv.style.direction = 'rtl';
                pdfContentDiv.style.padding = '20mm';
                pdfContentDiv.style.backgroundColor = '#fff';
                pdfContentDiv.style.width = '210mm'; // A4 width
                pdfContentDiv.style.boxSizing = 'border-box';
                pdfContentDiv.style.position = 'absolute';
                pdfContentDiv.style.left = '-9999px'; // Hide it off-screen

                // Construct the HTML content for PDF
                let pdfHtml = `
                    <h1 style="text-align: center; color: #00897b; font-size: 24pt; margin-bottom: 15pt;">${schoolName}</h1>
                    <div style="font-size: 12pt; margin-bottom: 10pt;">
                        <p style="text-align: right; margin: 0;">Ø·Ø§Ù„Ø¨ Ø¹Ù„Ù…: ${studentName}</p>
                        <p style="text-align: left; margin: 0; margin-top: -12pt;">Ø±ÙˆÙ„ Ù†Ù…Ø¨Ø±: ${rollNumber}</p>
                        <p style="text-align: right; margin: 0;">Ú©Ù„Ø§Ø³: ${className}</p>
                        <p style="text-align: left; margin: 0; margin-top: -12pt;">Ø³ÛŒÚ©Ø´Ù†: ${classSection}</p>
                    </div>
                    <h3 style="text-align: right; color: #00897b; font-size: 16pt; margin-top: 15pt; margin-bottom: 10pt; border-bottom: 1px solid #b2dfdb; padding-bottom: 5pt;">Ù†ØªØ§Ø¦Ø¬:</h3>
                    <table style="width: 100%; border-collapse: collapse; font-size: 10pt;">
                        <thead>
                            <tr style="background-color: #f0f0f0;">
                                <th style="padding: 5pt; border: 1px solid #ddd; text-align: right;">Ù…Ø¶Ù…ÙˆÙ†</th>
                                <th style="padding: 5pt; border: 1px solid #ddd; text-align: center;">Ú©Ù„ Ù†Ù…Ø¨Ø±</th>
                                <th style="padding: 5pt; border: 1px solid #ddd; text-align: center;">Ø­Ø§ØµÙ„ Ú©Ø±Ø¯Û Ù†Ù…Ø¨Ø±</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                let totalMarks = 0;
                let obtainedMarks = 0;

                for (const index of subjectsData) {
                    const subjectName = document.getElementById(`subject_name_${index}`).value.trim();
                    const total = parseInt(document.getElementById(`subject_total_${index}`).value) || 0;
                    const obtained = parseInt(document.getElementById(`subject_obtained_${index}`).value) || 0;

                    if (!subjectName || isNaN(total) || isNaN(obtained) || total < 0 || obtained < 0 || obtained > total) {
                        showMessage(`Ø¨Ø±Ø§Û Ú©Ø±Ù… Ù…Ø¶Ù…ÙˆÙ† "${subjectName || 'Ù†Ø§Ù…Ø¹Ù„ÙˆÙ… Ù…Ø¶Ù…ÙˆÙ†'}" Ú©Û’ Ù„ÛŒÛ’ Ø¯Ø±Ø³Øª Ù†Ù…Ø¨Ø± Ø¯Ø±Ø¬ Ú©Ø±ÛŒÚºÛ”`, 'warning');
                        // Restore buttons and messages
                        buttons.forEach(btn => btn.style.display = 'inline-block');
                        return; // Stop PDF generation
                    }

                    totalMarks += total;
                    obtainedMarks += obtained;

                    pdfHtml += `
                        <tr>
                            <td style="padding: 5pt; border: 1px solid #ddd; text-align: right;">${subjectName}</td>
                            <td style="padding: 5pt; border: 1px solid #ddd; text-align: center;">${total}</td>
                            <td style="padding: 5pt; border: 1px solid #ddd; text-align: center;">${obtained}</td>
                        </tr>
                    `;
                }

                pdfHtml += `
                        </tbody>
                    </table>
                `;

                const percentage = totalMarks > 0 ? ((obtainedMarks / totalMarks) * 100).toFixed(2) : 0;
                const result = percentage >= 40 ? 'Ù¾Ø§Ø³' : 'ÙÛŒÙ„';

                pdfHtml += `
                    <div style="font-size: 12pt; margin-top: 15pt;">
                        <p style="text-align: right; margin: 0;">Ù…Ø¬Ù…ÙˆØ¹ÛŒ Ù†Ù…Ø¨Ø±: ${obtainedMarks} / ${totalMarks}</p>
                        <p style="text-align: right; margin: 0;">ÙÛŒØµØ¯: ${percentage}%</p>
                        <p style="text-align: right; margin: 0;">Ù†ØªÛŒØ¬Û: ${result}</p>
                    </div>
                `;

                if (teacherRemarks) {
                    pdfHtml += `
                        <div style="font-size: 12pt; margin-top: 15pt;">
                            <p style="text-align: right; margin: 0; font-weight: bold;">Ø§Ø³ØªØ§Ø¯ Ú©Û’ Ø±ÛŒÙ…Ø§Ø±Ú©Ø³:</p>
                            <p style="text-align: right; margin: 0;">${teacherRemarks}</p>
                        </div>
                    `;
                }

                pdfHtml += `
                    <div style="font-size: 12pt; margin-top: 20pt; display: flex; justify-content: space-between;">
                        <p style="text-align: right; margin: 0;">Ú©Ù„Ø§Ø³ Ø§Ù†Ú†Ø§Ø±Ø¬: ${classIncharge}</p>
                        <div style="text-align: left; margin: 0;">
                            <p style="margin: 0;">Ø¯Ø³ØªØ®Ø·:</p>
                            <div style="border-bottom: 1px solid #000; width: 100pt; margin-top: 5pt;"></div>
                        </div>
                    </div>
                `;

                pdfContentDiv.innerHTML = pdfHtml;
                document.body.appendChild(pdfContentDiv);

                // Use html2canvas to capture the content
                const canvas = await html2canvas(pdfContentDiv, { scale: 2, useCORS: true, logging: false }); // Scale for better resolution
                const imgData = canvas.toDataURL('image/png');

                // Calculate image dimensions to fit PDF page
                const imgWidth = 190; // A4 width minus margins (210 - 20)
                const pageHeight = doc.internal.pageSize.getHeight();
                const imgHeight = canvas.height * imgWidth / canvas.width;
                let heightLeft = imgHeight;

                let position = 10; // Initial Y position with margin

                // Add image to PDF, handling multiple pages if content is too long
                doc.addImage(imgData, 'PNG', 10, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;

                while (heightLeft >= 0) {
                    position = heightLeft - imgHeight + 10; // Adjust position for next page
                    doc.addPage();
                    doc.addImage(imgData, 'PNG', 10, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }

                doc.save(`${studentName}_Ø±Ø²Ù„Ù¹.pdf`);
                showMessage('Ù¾ÛŒ ÚˆÛŒ Ø§ÛŒÙ Ú©Ø§Ù…ÛŒØ§Ø¨ÛŒ Ø³Û’ ØªÛŒØ§Ø± ÛÙˆ Ú¯Ø¦ÛŒ ÛÛ’Û”', 'success');


            } catch (error) {
                console.error('PDF Ø¬Ù†Ø±ÛŒØ´Ù† Ù…ÛŒÚº Ø®Ø±Ø§Ø¨ÛŒ:', error);
                showMessage('Ù¾ÛŒ ÚˆÛŒ Ø§ÛŒÙ ØªÛŒØ§Ø± Ú©Ø±Ù†Û’ Ù…ÛŒÚº Ø®Ø±Ø§Ø¨ÛŒ Ù¾ÛŒØ´ Ø¢Ø¦ÛŒÛ”', 'error');
            } finally {
                // Restore buttons and messages
                buttons.forEach(btn => btn.style.display = 'inline-block');
                if (pdfContentDiv && document.body.contains(pdfContentDiv)) { // Check if pdfContentDiv is defined and exists
                    document.body.removeChild(pdfContentDiv); // Clean up temporary div
                }
            }
        }

        /**
         * Shares a message via WhatsApp after generating the PDF.
         */
        async function shareOnWhatsApp() {
            // First, generate the PDF (this will trigger a download)
            await generatePDF();

            const studentName = document.getElementById('studentName').value.trim();
            const shareText = `Ø§Ù„Ø³Ù„Ø§Ù… Ø¹Ù„ÛŒÚ©Ù…! ${studentName} Ú©Ø§ Ø±Ø²Ù„Ù¹ Ú©Ø§Ø±Úˆ ØªÛŒØ§Ø± ÛÙˆ Ú¯ÛŒØ§ ÛÛ’Û” Ø¨Ø±Ø§Û Ú©Ø±Ù… Ø§Ø³Û’ Ø§Ù¾Ù†Û’ Ø¨Ø±Ø§Ø¤Ø²Ø± Ú©Û’ ÚˆØ§Ø¤Ù† Ù„ÙˆÚˆØ² ÙÙˆÙ„ÚˆØ± Ø³Û’ Ø¯ÛŒÚ©Ú¾ÛŒÚºÛ”`;
            const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(shareText)}`;

            // Open WhatsApp in a new tab/window
            window.open(whatsappUrl, '_blank');
            showMessage('ÙˆØ§Ù¹Ø³ Ø§ÛŒÙ¾ Ø´ÛŒØ¦Ø±Ù†Ú¯ Ú©Û’ Ù„ÛŒÛ’ Ø§ÛŒÚ© Ù†ÛŒØ§ Ù¹ÛŒØ¨ Ú©Ú¾Ù„ Ú¯ÛŒØ§ ÛÛ’Û”', 'info');
        }

        /**
         * Downloads all class data as an Excel file from Firestore.
         */
        async function downloadClassDataAsExcel() {
            if (!window.db || !window.currentUserId) {
                console.error("Firestore or User ID not available.");
                showMessage('Ø§ÛŒÚ©Ø³Ù„ ÚˆØ§Ø¤Ù† Ù„ÙˆÚˆ Ú©Û’ Ù„ÛŒÛ’ ÙØ§Ø¦Ø± Ø¨ÛŒØ³ ØªÛŒØ§Ø± Ù†ÛÛŒÚº ÛÛ’Û”', 'error');
                return;
            }

            const loadingIndicator = document.getElementById('loadingIndicator');
            loadingIndicator.textContent = 'Ø§ÛŒÚ©Ø³Ù„ ÙØ§Ø¦Ù„ ØªÛŒØ§Ø± Ú©ÛŒ Ø¬Ø§ Ø±ÛÛŒ ÛÛ’...';
            loadingIndicator.style.display = 'block';
            showMessage('', 'info'); // Clear previous messages

            try {
                const collectionPath = `artifacts/${window.__app_id}/users/${window.currentUserId}/class_results`;
                const q = window.query(window.collection(window.db, collectionPath));
                const querySnapshot = await window.getDocs(q);

                let allStudentData = [];
                // Define fixed headers in the desired order
                const fixedHeaders = [
                    "Ø³Ú©ÙˆÙ„ Ú©Ø§ Ù†Ø§Ù…", "Ú©Ù„Ø§Ø³ Ú©Ø§ Ù†Ø§Ù…", "Ú©Ù„Ø§Ø³ Ø³ÛŒÚ©Ø´Ù†", "Ú©Ù„Ø§Ø³ Ø§Ù†Ú†Ø§Ø±Ø¬ Ú©Ø§ Ù†Ø§Ù…",
                    "Ø·Ø§Ù„Ø¨ Ø¹Ù„Ù… Ú©Ø§ Ù†Ø§Ù…", "Ø±ÙˆÙ„ Ù†Ù…Ø¨Ø±", "Ù…Ø¬Ù…ÙˆØ¹ÛŒ Ù†Ù…Ø¨Ø± (Ø­Ø§ØµÙ„ Ú©Ø±Ø¯Û)", "Ù…Ø¬Ù…ÙˆØ¹ÛŒ Ù†Ù…Ø¨Ø± (Ú©Ù„)",
                    "ÙÛŒØµØ¯", "Ù†ØªÛŒØ¬Û", "ØªØ§Ø±ÛŒØ®"
                ];
                let dynamicSubjectHeaders = new Set(); // To collect unique subject headers

                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    let studentRow = {
                        "Ø³Ú©ÙˆÙ„ Ú©Ø§ Ù†Ø§Ù…": data.schoolName || '',
                        "Ú©Ù„Ø§Ø³ Ú©Ø§ Ù†Ø§Ù…": data.className || '',
                        "Ú©Ù„Ø§Ø³ Ø³ÛŒÚ©Ø´Ù†": data.classSection || '',
                        "Ú©Ù„Ø§Ø³ Ø§Ù†Ú†Ø§Ø±Ø¬ Ú©Ø§ Ù†Ø§Ù…": data.classIncharge || '',
                        "Ø·Ø§Ù„Ø¨ Ø¹Ù„Ù… Ú©Ø§ Ù†Ø§Ù…": data.studentName || '',
                        "Ø±ÙˆÙ„ Ù†Ù…Ø¨Ø±": data.rollNumber || '',
                        "Ù…Ø¬Ù…ÙˆØ¹ÛŒ Ù†Ù…Ø¨Ø± (Ø­Ø§ØµÙ„ Ú©Ø±Ø¯Û)": data.obtainedMarks || 0,
                        "Ù…Ø¬Ù…ÙˆØ¹ÛŒ Ù†Ù…Ø¨Ø± (Ú©Ù„)": data.totalMarks || 0,
                        "ÙÛŒØµØ¯": data.percentage ? `${data.percentage}%` : '0%',
                        "Ù†ØªÛŒØ¬Û": data.result || '',
                        "ØªØ§Ø±ÛŒØ®": data.timestamp ? new Date(data.timestamp.toDate()).toLocaleDateString('ur-PK') : '' // Convert Firestore Timestamp to readable date
                    };

                    // Add subject columns dynamically and collect their headers
                    if (data.subjects && Array.isArray(data.subjects)) {
                        data.subjects.forEach(subject => {
                            const subjectName = subject.name || 'Ù†Ø§Ù…Ø¹Ù„ÙˆÙ… Ù…Ø¶Ù…ÙˆÙ†';
                            const obtained = subject.obtained || 0;
                            const total = subject.total || 0;
                            studentRow[`${subjectName} (Ø­Ø§ØµÙ„ Ú©Ø±Ø¯Û)`] = obtained;
                            studentRow[`${subjectName} (Ú©Ù„)`] = total;
                            dynamicSubjectHeaders.add(`${subjectName} (Ø­Ø§ØµÙ„ Ú©Ø±Ø¯Û)`);
                            dynamicSubjectHeaders.add(`${subjectName} (Ú©Ù„)`);
                        });
                    }
                    studentRow["Ø§Ø³ØªØ§Ø¯ Ú©Û’ Ø±ÛŒÙ…Ø§Ø±Ú©Ø³"] = data.teacherRemarks || ''; // Add remarks to the row data
                    allStudentData.push(studentRow);
                });

                if (allStudentData.length === 0) {
                    showMessage('ÚˆØ§Ø¤Ù† Ù„ÙˆÚˆ Ú©Ø±Ù†Û’ Ú©Û’ Ù„ÛŒÛ’ Ú©ÙˆØ¦ÛŒ ÚˆÛŒÙ¹Ø§ Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛÛŒÚº ÛÛ’Û”', 'info');
                    return;
                }

                // Combine fixed headers, sorted dynamic headers, and then remarks
                let finalHeaders = [...fixedHeaders];
                const sortedDynamicSubjectHeaders = Array.from(dynamicSubjectHeaders).sort((a, b) => a.localeCompare(b, 'ur'));
                finalHeaders = finalHeaders.concat(sortedDynamicSubjectHeaders);
                finalHeaders.push("Ø§Ø³ØªØ§Ø¯ Ú©Û’ Ø±ÛŒÙ…Ø§Ø±Ú©Ø³"); // Ensure remarks is the very last column

                // Ensure all rows have all headers, filling missing with empty string
                const formattedData = allStudentData.map(row => {
                    const newRow = {};
                    finalHeaders.forEach(header => {
                        newRow[header] = row[header] !== undefined ? row[header] : '';
                    });
                    return newRow;
                });

                const ws = XLSX.utils.json_to_sheet(formattedData, { header: finalHeaders });
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Ú©Ù„Ø§Ø³ Ø±Ø²Ù„Ù¹");
                XLSX.writeFile(wb, "Ú©Ù„Ø§Ø³_Ø±Ø²Ù„Ù¹.xlsx");

                showMessage('Ø§ÛŒÚ©Ø³Ù„ ÙØ§Ø¦Ù„ Ú©Ø§Ù…ÛŒØ§Ø¨ÛŒ Ø³Û’ ØªÛŒØ§Ø± ÛÙˆ Ú¯Ø¦ÛŒ ÛÛ’Û”', 'success');

            } catch (error) {
                console.error("Error downloading Excel:", error);
                showMessage('Ø§ÛŒÚ©Ø³Ù„ ÙØ§Ø¦Ù„ ØªÛŒØ§Ø± Ú©Ø±Ù†Û’ Ù…ÛŒÚº Ø®Ø±Ø§Ø¨ÛŒ Ù¾ÛŒØ´ Ø¢Ø¦ÛŒÛ”', 'error');
            } finally {
                loadingIndicator.style.display = 'none';
            }
        }
    </script>
</body>
</html>
