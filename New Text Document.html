<!DOCTYPE html>
<html lang="ur" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>رزلٹ کارڈ جنریٹر</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, query, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Firebase variables (provided by Canvas environment)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null; // Corrected line

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        window.db = getFirestore(app); // Make db globally accessible
        window.auth = getAuth(app); // Make auth globally accessible
        window.currentUserId = null; // To store the current user's ID

        // Make Firestore functions globally accessible
        window.collection = collection;
        window.addDoc = addDoc;
        window.getDocs = getDocs;
        window.query = query;
        window.where = where;


        // Authenticate user
        onAuthStateChanged(window.auth, async (user) => {
            if (user) {
                window.currentUserId = user.uid;
                console.log("Firebase authenticated. User ID:", user.uid);
            } else {
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(window.auth, initialAuthToken);
                        window.currentUserId = window.auth.currentUser.uid;
                        console.log("Signed in with custom token. User ID:", window.currentUserId);
                    } else {
                        await signInAnonymously(window.auth);
                        window.currentUserId = window.auth.currentUser.uid;
                        console.log("Signed in anonymously. User ID:", window.currentUserId);
                    }
                } catch (error) {
                    console.error("Firebase authentication error:", error);
                    showMessage('فائر بیس کی تصدیق میں خرابی پیش آئی۔', 'error');
                }
            }
        });
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Nastaliq+Urdu:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* General Body Styling */
        body {
            font-family: 'Noto Nastaliq Urdu', serif;
            direction: rtl;
            background-color: #e0f7fa; /* Light Teal Background */
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            line-height: 1.6;
            color: #37474f; /* Dark Gray Text */
        }

        /* Container for the form */
        .container {
            background-color: #fff;
            padding: 30px;
            border-radius: 15px;
            max-width: 700px;
            width: 100%;
            box-shadow: 0 8px 24px rgba(0,0,0,0.15); /* Enhanced shadow */
            box-sizing: border-box; /* Include padding in width */
        }

        /* Heading Style */
        h1 {
            text-align: center;
            color: #00897b; /* Teal Primary Color */
            margin-bottom: 30px;
            font-size: 2.2em; /* Larger heading */
            font-weight: 700;
        }

        /* Label Styling */
        label {
            display: block;
            margin-top: 15px;
            font-weight: bold;
            color: #263238; /* Even darker gray for labels */
            font-size: 1.1em;
        }

        /* Input Field Styling */
        input[type="text"],
        input[type="number"],
        textarea {
            margin-top: 8px;
            padding: 12px;
            width: calc(100% - 24px); /* Account for padding */
            border-radius: 8px;
            border: 1px solid #80cbc4; /* Medium Teal Border */
            font-size: 1.05em;
            box-sizing: border-box;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }

        input[type="text"]:focus,
        input[type="number"]:focus,
        textarea:focus {
            border-color: #00897b; /* Darker teal on focus */
            box-shadow: 0 0 0 3px rgba(0, 137, 123, 0.2); /* Focus ring */
            outline: none;
        }

        textarea {
            resize: vertical; /* Allow vertical resizing */
            min-height: 80px; /* Minimum height for textarea */
        }

        /* Button Styling */
        button {
            margin-top: 25px;
            padding: 12px 25px;
            font-size: 1.1em;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
            font-weight: bold;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.2);
        }

        /* Specific Button Colors */
        #step1 button {
            background-color: #1e88e5; /* Blue */
            color: white;
        }
        #step1 button:hover {
            background-color: #1565c0;
        }

        #step2 .button-group button {
            margin-right: 10px; /* Spacing between buttons */
            margin-left: 10px; /* Spacing between buttons */
        }
        #step2 .button-group button.clear-button { /* New Clear Button */
            background-color: #607d8b; /* Grey */
            color: white;
        }
        #step2 .button-group button.clear-button:hover {
            background-color: #455a64;
        }
        #step2 .button-group button:first-of-type { /* Add Subject */
            background-color: #43a047; /* Green */
            color: white;
        }
        #step2 .button-group button:first-of-type:hover {
            background-color: #2e7d32;
        }
        #step2 .button-group button:nth-of-type(2) { /* Generate Remarks */
            background-color: #ff9800; /* Orange */
            color: white;
        }
        #step2 .button-group button:nth-of-type(2):hover {
            background-color: #f57c00;
        }
        #step2 .button-group button:nth-of-type(3) { /* Generate PDF */
            background-color: #1e88e5; /* Blue */
            color: white;
        }
        #step2 .button-group button:nth-of-type(3):hover {
            background-color: #1565c0;
        }
        #step2 .button-group button.share-button { /* Share on WhatsApp */
            background-color: #25d366; /* WhatsApp Green */
            color: white;
        }
        #step2 .button-group button.share-button:hover {
            background-color: #1da851;
        }
        #step2 .button-group button.excel-button { /* Download Excel */
            background-color: #107c41; /* Dark Green for Excel */
            color: white;
        }
        #step2 .button-group button.excel-button:hover {
            background-color: #0b5e2f;
        }
        #step2 .button-group button:last-of-type { /* Back button */
            background-color: #e53935; /* Red */
            color: white;
        }
        #step2 .button-group button:last-of-type:hover {
            background-color: #b71c1c;
        }

        /* Subject Row Layout */
        .subject-row {
            margin-top: 15px;
            display: grid;
            grid-template-columns: 3fr 1.2fr 1.2fr 0.5fr; /* Adjusted column widths */
            gap: 10px;
            align-items: center;
        }
        .subject-row input {
            width: 100%; /* Ensure inputs fill their grid cell */
            margin-top: 0; /* Remove extra margin from general input rule */
        }

        /* Subject Heading */
        h3 {
            color: #00897b;
            margin-top: 25px;
            margin-bottom: 15px;
            text-align: center;
            font-size: 1.5em;
            border-bottom: 2px solid #b2dfdb; /* Underline effect */
            padding-bottom: 5px;
            display: block; /* Ensure it takes full width */
        }

        /* Remove Subject Button */
        .remove-subject {
            background: none;
            border: none;
            color: #e53935; /* Red for delete */
            font-size: 1.8em; /* Larger 'x' */
            cursor: pointer;
            padding: 5px;
            outline: none;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%; /* Align vertically in grid */
            box-shadow: none; /* No shadow for this button */
        }
        .remove-subject:hover {
            color: #b71c1c;
            transform: scale(1.1); /* Slight grow on hover */
            box-shadow: none;
        }

        /* Centering for buttons */
        .button-group {
            text-align: center;
            margin-top: 30px;
        }

        /* Message Box Styling */
        #messageBox {
            padding: 10px;
            margin-top: 15px;
            border-radius: 8px;
            text-align: center;
            font-weight: bold;
            display: none; /* Hidden by default */
        }
        #loadingIndicator {
            text-align: center;
            margin-top: 15px;
            color: #00897b;
            font-weight: bold;
            display: none; /* Hidden by default */
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .container {
                padding: 20px;
                margin: 10px;
            }
            h1 {
                font-size: 1.8em;
            }
            .button-group button {
                width: 100%;
                margin-top: 15px;
                margin-right: 0 !important; /* Override inline style for step2 buttons */
                margin-left: 0 !important;
            }
            .subject-row {
                grid-template-columns: 1fr; /* Stack inputs on small screens */
            }
            .subject-row input {
                width: 100%;
            }
            .remove-subject {
                width: 100%;
                margin-top: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>سکول رزلٹ کارڈ جنریٹر</h1>

        <div id="step1">
            <label for="schoolName">سکول کا نام:</label>
            <input type="text" id="schoolName" placeholder="مثلاً، الحمراء سکول" />

            <label for="className">کلاس کا نام:</label>
            <input type="text" id="className" placeholder="مثلاً، دسویں جماعت" />

            <label for="classSection">کلاس سیکشن:</label>
            <input type="text" id="classSection" placeholder="مثلاً، سیکشن الف" />

            <label for="classIncharge">کلاس انچارج کا نام:</label>
            <input type="text" id="classIncharge" placeholder="مثلاً، استاد احمد" />

            <div class="button-group">
                <button onclick="goToStep2()">اگلا ➡️</button>
            </div>
        </div>

        <div id="step2" style="display:none;">
            <label for="studentName">طالب علم کا نام:</label>
            <input type="text" id="studentName" placeholder="مثلاً، محمد علی" />

            <label for="rollNumber">رول نمبر:</label>
            <input type="text" id="rollNumber" placeholder="مثلاً، 12345" />

            <h3 id="subjects-heading" style="display:none;">مضامین کی تفصیل:</h3>
            <div id="subjects">
                </div>

            <label for="teacherRemarks">استاد کے ریمارکس:</label>
            <textarea id="teacherRemarks" rows="4" placeholder="یہاں استاد کے ریمارکس دکھائے جائیں گے..."></textarea>

            <div class="button-group">
                <button onclick="addSubject()">+ مضمون شامل کریں</button>
                <button onclick="generateRemarks()">✨ ریمارکس بنائیں</button>
                <button onclick="generatePDF()">📄 پی ڈی ایف بنائیں</button>
                <button class="share-button" onclick="shareOnWhatsApp()">WhatsApp پر شیئر کریں</button>
                <button class="excel-button" onclick="downloadClassDataAsExcel()">📊 Excel میں ڈائون لوڈ کریں</button>
                <button class="clear-button" onclick="clearStudentData()">نیا رزلٹ کارڈ</button>
                <button onclick="goToStep1()">⬅️ واپس</button>
            </div>
            <div id="loadingIndicator">
                ریمارکس تیار کیے جا رہے ہیں...
            </div>
            <div id="messageBox"></div>
        </div>
    </div>

    <script>
        // Global Firebase instances (initialized in the <script type="module"> block)
        let db;
        let auth;
        let currentUserId; // This will be set after Firebase auth state changes

        // Array to keep track of subject input elements' IDs
        let subjectsData = [];
        const subjectsContainer = document.getElementById('subjects');
        const subjectsHeading = document.getElementById('subjects-heading');

        // Default subject names to pre-fill
        const defaultSubjectNames = ["اردو", "انگریزی", "ریاضی", "سائنس", "اسلامیات"];

        /**
         * Displays a message to the user in a styled box.
         * @param {string} message - The message to display.
         * @param {string} type - The type of message ('info', 'warning', 'error', 'success').
         */
        function showMessage(message, type = 'info') {
            const messageBox = document.getElementById('messageBox');
            messageBox.textContent = message;
            messageBox.style.display = 'block';
            if (type === 'warning') {
                messageBox.style.backgroundColor = '#ffe0b2'; /* Light orange */
                messageBox.style.color = '#e65100'; /* Dark orange */
            } else if (type === 'error') {
                messageBox.style.backgroundColor = '#ffcdd2'; /* Light red */
                messageBox.style.color = '#d32f2f'; /* Dark red */
            } else if (type === 'success') {
                messageBox.style.backgroundColor = '#c8e6c9'; /* Light green */
                messageBox.style.color = '#388e3c'; /* Dark green */
            } else { /* Default info */
                messageBox.style.backgroundColor = '#bbdefb'; /* Light blue */
                messageBox.style.color = '#1976d2'; /* Dark blue */
            }
            // Hide the message after 5 seconds
            setTimeout(() => {
                messageBox.style.display = 'none';
            }, 5000);
        }

        /**
         * Navigates from Step 1 to Step 2 of the form.
         * Adds a default subject row if none exist.
         */
        function goToStep2() {
            // Basic validation for Step 1 fields
            const schoolName = document.getElementById('schoolName').value.trim();
            const className = document.getElementById('className').value.trim();
            const classSection = document.getElementById('classSection').value.trim();
            const classIncharge = document.getElementById('classIncharge').value.trim();

            if (!schoolName || !className || !classSection || !classIncharge) {
                showMessage('براہ کرم تمام سکول کی معلومات پُر کریں۔', 'warning');
                return;
            }

            document.getElementById('step1').style.display = 'none';
            document.getElementById('step2').style.display = 'block';
            // Add default subjects if no subjects have been added yet
            if (subjectsData.length === 0) {
                defaultSubjectNames.forEach(name => addSubject(name, 100)); // Pre-fill with default names and 100 total marks
            }
            // Hide message box and loading indicator when changing steps
            document.getElementById('messageBox').style.display = 'none';
            document.getElementById('loadingIndicator').style.display = 'none';
        }

        /**
         * Navigates from Step 2 back to Step 1.
         * Clears subject data for a fresh start on Step 2 next time.
         */
        function goToStep1() {
            document.getElementById('step2').style.display = 'none';
            document.getElementById('step1').style.display = 'block';
            // Clear all student-specific data
            clearStudentData(false); // Do not re-add default subjects here
            // Hide message box and loading indicator when changing steps
            document.getElementById('messageBox').style.display = 'none';
            document.getElementById('loadingIndicator').style.display = 'none';
        }

        /**
         * Clears all student-specific data on Step 2 and prepares for a new student.
         * @param {boolean} reAddDefaults - Whether to re-add default subjects after clearing.
         */
        function clearStudentData(reAddDefaults = true) {
            document.getElementById('studentName').value = '';
            document.getElementById('rollNumber').value = '';
            document.getElementById('teacherRemarks').value = '';
            subjectsContainer.innerHTML = ''; // Clear all subject rows
            subjectsData = []; // Reset the subjectsData array
            subjectsHeading.style.display = 'none'; // Hide the heading

            if (reAddDefaults) {
                defaultSubjectNames.forEach(name => addSubject(name, 100)); // Re-fill with default names and 100 total marks
            }
            showMessage('نئے طالب علم کے لیے فارم صاف کر دیا گیا ہے۔', 'info');
        }

        /**
         * Adds a new subject input row to the form.
         * @param {string} [defaultName=''] - Optional default name for the subject.
         * @param {number} [defaultTotal=0] - Optional default total marks for the subject.
         */
        function addSubject(defaultName = '', defaultTotal = '') {
            subjectsHeading.style.display = 'block'; // Show the heading when subjects are present

            // Create a unique index for the new subject row
            const newIndex = subjectsData.length > 0 ? Math.max(...subjectsData) + 1 : 0;
            subjectsData.push(newIndex); // Add the new index to our tracking array

            const div = document.createElement('div');
            div.className = 'subject-row';
            div.setAttribute('data-index', newIndex); // Store the unique index on the div

            div.innerHTML = `
                <input type="text" placeholder="مضمون کا نام" id="subject_name_${newIndex}" value="${defaultName}" />
                <input type="number" placeholder="کل نمبر" id="subject_total_${newIndex}" min="0" value="${defaultTotal}" />
                <input type="number" placeholder="حاصل کردہ نمبر" id="subject_obtained_${newIndex}" min="0" />
                <button class="remove-subject" onclick="removeSubject(${newIndex})">×</button>
            `;
            subjectsContainer.appendChild(div);
        }

        /**
         * Removes a specific subject input row from the form.
         * @param {number} indexToRemove - The unique index of the subject row to remove.
         */
        function removeSubject(indexToRemove) {
            const rowToRemove = subjectsContainer.querySelector(`.subject-row[data-index="${indexToRemove}"]`);
            if (rowToRemove) {
                subjectsContainer.removeChild(rowToRemove);
                // Remove the index from the subjectsData array
                subjectsData = subjectsData.filter(index => index !== indexToRemove);

                // Hide the heading if no subjects are left
                if (subjectsData.length === 0) {
                    subjectsHeading.style.display = 'none';
                }
            }
        }

        /**
         * Generates academic remarks using the Gemini API based on student performance.
         */
        async function generateRemarks() {
            const studentName = document.getElementById('studentName').value.trim();
            const className = document.getElementById('className').value.trim();
            const schoolName = document.getElementById('schoolName').value.trim();
            const teacherRemarksTextArea = document.getElementById('teacherRemarks');
            const loadingIndicator = document.getElementById('loadingIndicator');
            const generateRemarksBtn = document.querySelector('button[onclick="generateRemarks()"]');

            if (!studentName || !className || subjectsData.length === 0) {
                showMessage('براہ کرم طالب علم کا نام، کلاس، اور مضامین کی تفصیلات مکمل کریں۔', 'warning');
                return;
            }

            loadingIndicator.style.display = 'block';
            generateRemarksBtn.disabled = true;
            teacherRemarksTextArea.value = ''; // Clear previous remarks
            showMessage('', 'info'); // Clear any previous messages

            let subjectDetails = [];
            let totalMarks = 0;
            let obtainedMarks = 0;

            // Gather subject data for the prompt
            subjectsData.forEach(index => {
                const subjectName = document.getElementById(`subject_name_${index}`).value.trim();
                const total = parseInt(document.getElementById(`subject_total_${index}`).value) || 0;
                const obtained = parseInt(document.getElementById(`subject_obtained_${index}`).value) || 0;

                if (subjectName && !isNaN(total) && !isNaN(obtained) && total >= 0 && obtained >= 0) {
                    subjectDetails.push(`${subjectName}: ${obtained}/${total}`);
                    totalMarks += total;
                    obtainedMarks += obtained;
                }
            });

            const percentage = totalMarks > 0 ? ((obtainedMarks / totalMarks) * 100).toFixed(2) : 0;
            const result = percentage >= 40 ? 'پاس' : 'فیل';

            // Construct the prompt for the LLM
            const prompt = `Generate a concise (max 60 words) and appropriate academic remark in Urdu for a student with the following performance on their school result card. The remark should be encouraging if the student passed, and constructive with suggestions for improvement if the student failed. Do not mention specific marks or percentages, focus on general performance and effort.

            Student Name: ${studentName}
            Class: ${className}
            School: ${schoolName}
            Subject Performance: ${subjectDetails.join(', ')}
            Overall Result: ${result} (Percentage: ${percentage}%)
            `;

            try {
                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                const payload = { contents: chatHistory };
                const apiKey = ""; // Leave as empty string, Canvas will provide it
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const resultData = await response.json();

                if (resultData.candidates && resultData.candidates.length > 0 &&
                    resultData.candidates[0].content && resultData.candidates[0].content.parts &&
                    resultData.candidates[0].content.parts.length > 0) {
                    const generatedText = resultData.candidates[0].content.parts[0].text;
                    teacherRemarksTextArea.value = generatedText;
                    showMessage('ریمارکس کامیابی سے تیار ہو گئے ہیں۔', 'success');
                } else {
                    console.error('Gemini API response structure unexpected:', resultData);
                    showMessage('ریمارکس تیار کرنے میں ناکامی: غیر متوقع جواب۔', 'error');
                }
            } catch (error) {
                console.error('Error generating remarks:', error);
                showMessage('ریمارکس تیار کرنے میں خرابی پیش آئی۔', 'error');
            } finally {
                loadingIndicator.style.display = 'none';
                generateRemarksBtn.disabled = false;
            }
        }

        /**
         * Saves the current student's result data to Firestore.
         */
        async function saveStudentResult() {
            if (!window.db || !window.currentUserId) {
                console.error("Firestore or User ID not available.");
                showMessage('ڈیٹا محفوظ کرنے کے لیے فائر بیس تیار نہیں ہے۔', 'error');
                return;
            }

            const schoolName = document.getElementById('schoolName').value.trim();
            const className = document.getElementById('className').value.trim();
            const classSection = document.getElementById('classSection').value.trim();
            const classIncharge = document.getElementById('classIncharge').value.trim();
            const studentName = document.getElementById('studentName').value.trim();
            const rollNumber = document.getElementById('rollNumber').value.trim();
            const teacherRemarks = document.getElementById('teacherRemarks').value.trim();

            let subjectsArray = [];
            let totalMarks = 0;
            let obtainedMarks = 0;

            subjectsData.forEach(index => {
                const subjectName = document.getElementById(`subject_name_${index}`).value.trim();
                const total = parseInt(document.getElementById(`subject_total_${index}`).value) || 0;
                const obtained = parseInt(document.getElementById(`subject_obtained_${index}`).value) || 0;

                if (subjectName && !isNaN(total) && !isNaN(obtained) && total >= 0 && obtained >= 0) {
                    subjectsArray.push({ name: subjectName, total: total, obtained: obtained });
                    totalMarks += total;
                    obtainedMarks += obtained;
                }
            });

            const percentage = totalMarks > 0 ? ((obtainedMarks / totalMarks) * 100).toFixed(2) : 0;
            const result = percentage >= 40 ? 'پاس' : 'فیل';

            const studentResultData = {
                schoolName: schoolName,
                className: className,
                classSection: classSection,
                classIncharge: classIncharge,
                studentName: studentName,
                rollNumber: rollNumber,
                subjects: subjectsArray,
                totalMarks: totalMarks,
                obtainedMarks: obtainedMarks,
                percentage: percentage,
                result: result,
                teacherRemarks: teacherRemarks,
                timestamp: new Date()
            };

            try {
                const collectionPath = `artifacts/${window.__app_id}/users/${window.currentUserId}/class_results`;
                await window.addDoc(window.collection(window.db, collectionPath), studentResultData);
                console.log("Student data saved to Firestore successfully!");
                showMessage('طالب علم کا ڈیٹا کامیابی سے محفوظ ہو گیا ہے۔', 'success');
            } catch (error) {
                console.error("Error saving student data to Firestore:", error);
                showMessage('طالب علم کا ڈیٹا محفوظ کرنے میں خرابی پیش آئی۔', 'error');
            }
        }

        /**
         * Generates the PDF result card by converting HTML content to an image.
         */
        async function generatePDF() {
            // First, save the student's data to Firestore
            await saveStudentResult();

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4'); // Portrait, millimeters, A4 size

            // Hide buttons and elements not meant for the PDF capture
            const buttons = document.querySelectorAll('.button-group button');
            buttons.forEach(btn => btn.style.display = 'none');
            const messageBox = document.getElementById('messageBox');
            messageBox.style.display = 'none';
            const loadingIndicator = document.getElementById('loadingIndicator');
            loadingIndicator.style.display = 'none';

            // Declare pdfContentDiv outside the try block
            let pdfContentDiv = null; 

            // Get the main container element to convert to canvas
            const schoolName = document.getElementById('schoolName').value.trim();
            const className = document.getElementById('className').value.trim();
            const classSection = document.getElementById('classSection').value.trim();
            const classIncharge = document.getElementById('classIncharge').value.trim();
            const studentName = document.getElementById('studentName').value.trim();
            const rollNumber = document.getElementById('rollNumber').value.trim();
            const teacherRemarks = document.getElementById('teacherRemarks').value.trim();

            // Basic validation for Step 2 fields
            if (!studentName || !rollNumber || subjectsData.length === 0) {
                showMessage('براہ کرم طالب علم کی معلومات اور کم از کم ایک مضمون کی تفصیل درج کریں۔', 'warning');
                // Restore buttons and messages
                buttons.forEach(btn => btn.style.display = 'inline-block');
                return;
            }

            try {
                // Temporarily create a div to hold all content for PDF, including step1 data
                pdfContentDiv = document.createElement('div');
                pdfContentDiv.style.fontFamily = 'Noto Nastaliq Urdu, serif';
                pdfContentDiv.style.direction = 'rtl';
                pdfContentDiv.style.padding = '20mm';
                pdfContentDiv.style.backgroundColor = '#fff';
                pdfContentDiv.style.width = '210mm'; // A4 width
                pdfContentDiv.style.boxSizing = 'border-box';
                pdfContentDiv.style.position = 'absolute';
                pdfContentDiv.style.left = '-9999px'; // Hide it off-screen

                // Construct the HTML content for PDF
                let pdfHtml = `
                    <h1 style="text-align: center; color: #00897b; font-size: 24pt; margin-bottom: 15pt;">${schoolName}</h1>
                    <div style="font-size: 12pt; margin-bottom: 10pt;">
                        <p style="text-align: right; margin: 0;">طالب علم: ${studentName}</p>
                        <p style="text-align: left; margin: 0; margin-top: -12pt;">رول نمبر: ${rollNumber}</p>
                        <p style="text-align: right; margin: 0;">کلاس: ${className}</p>
                        <p style="text-align: left; margin: 0; margin-top: -12pt;">سیکشن: ${classSection}</p>
                    </div>
                    <h3 style="text-align: right; color: #00897b; font-size: 16pt; margin-top: 15pt; margin-bottom: 10pt; border-bottom: 1px solid #b2dfdb; padding-bottom: 5pt;">نتائج:</h3>
                    <table style="width: 100%; border-collapse: collapse; font-size: 10pt;">
                        <thead>
                            <tr style="background-color: #f0f0f0;">
                                <th style="padding: 5pt; border: 1px solid #ddd; text-align: right;">مضمون</th>
                                <th style="padding: 5pt; border: 1px solid #ddd; text-align: center;">کل نمبر</th>
                                <th style="padding: 5pt; border: 1px solid #ddd; text-align: center;">حاصل کردہ نمبر</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                let totalMarks = 0;
                let obtainedMarks = 0;

                for (const index of subjectsData) {
                    const subjectName = document.getElementById(`subject_name_${index}`).value.trim();
                    const total = parseInt(document.getElementById(`subject_total_${index}`).value) || 0;
                    const obtained = parseInt(document.getElementById(`subject_obtained_${index}`).value) || 0;

                    if (!subjectName || isNaN(total) || isNaN(obtained) || total < 0 || obtained < 0 || obtained > total) {
                        showMessage(`براہ کرم مضمون "${subjectName || 'نامعلوم مضمون'}" کے لیے درست نمبر درج کریں۔`, 'warning');
                        // Restore buttons and messages
                        buttons.forEach(btn => btn.style.display = 'inline-block');
                        return; // Stop PDF generation
                    }

                    totalMarks += total;
                    obtainedMarks += obtained;

                    pdfHtml += `
                        <tr>
                            <td style="padding: 5pt; border: 1px solid #ddd; text-align: right;">${subjectName}</td>
                            <td style="padding: 5pt; border: 1px solid #ddd; text-align: center;">${total}</td>
                            <td style="padding: 5pt; border: 1px solid #ddd; text-align: center;">${obtained}</td>
                        </tr>
                    `;
                }

                pdfHtml += `
                        </tbody>
                    </table>
                `;

                const percentage = totalMarks > 0 ? ((obtainedMarks / totalMarks) * 100).toFixed(2) : 0;
                const result = percentage >= 40 ? 'پاس' : 'فیل';

                pdfHtml += `
                    <div style="font-size: 12pt; margin-top: 15pt;">
                        <p style="text-align: right; margin: 0;">مجموعی نمبر: ${obtainedMarks} / ${totalMarks}</p>
                        <p style="text-align: right; margin: 0;">فیصد: ${percentage}%</p>
                        <p style="text-align: right; margin: 0;">نتیجہ: ${result}</p>
                    </div>
                `;

                if (teacherRemarks) {
                    pdfHtml += `
                        <div style="font-size: 12pt; margin-top: 15pt;">
                            <p style="text-align: right; margin: 0; font-weight: bold;">استاد کے ریمارکس:</p>
                            <p style="text-align: right; margin: 0;">${teacherRemarks}</p>
                        </div>
                    `;
                }

                pdfHtml += `
                    <div style="font-size: 12pt; margin-top: 20pt; display: flex; justify-content: space-between;">
                        <p style="text-align: right; margin: 0;">کلاس انچارج: ${classIncharge}</p>
                        <div style="text-align: left; margin: 0;">
                            <p style="margin: 0;">دستخط:</p>
                            <div style="border-bottom: 1px solid #000; width: 100pt; margin-top: 5pt;"></div>
                        </div>
                    </div>
                `;

                pdfContentDiv.innerHTML = pdfHtml;
                document.body.appendChild(pdfContentDiv);

                // Use html2canvas to capture the content
                const canvas = await html2canvas(pdfContentDiv, { scale: 2, useCORS: true, logging: false }); // Scale for better resolution
                const imgData = canvas.toDataURL('image/png');

                // Calculate image dimensions to fit PDF page
                const imgWidth = 190; // A4 width minus margins (210 - 20)
                const pageHeight = doc.internal.pageSize.getHeight();
                const imgHeight = canvas.height * imgWidth / canvas.width;
                let heightLeft = imgHeight;

                let position = 10; // Initial Y position with margin

                // Add image to PDF, handling multiple pages if content is too long
                doc.addImage(imgData, 'PNG', 10, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;

                while (heightLeft >= 0) {
                    position = heightLeft - imgHeight + 10; // Adjust position for next page
                    doc.addPage();
                    doc.addImage(imgData, 'PNG', 10, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }

                doc.save(`${studentName}_رزلٹ.pdf`);
                showMessage('پی ڈی ایف کامیابی سے تیار ہو گئی ہے۔', 'success');


            } catch (error) {
                console.error('PDF جنریشن میں خرابی:', error);
                showMessage('پی ڈی ایف تیار کرنے میں خرابی پیش آئی۔', 'error');
            } finally {
                // Restore buttons and messages
                buttons.forEach(btn => btn.style.display = 'inline-block');
                if (pdfContentDiv && document.body.contains(pdfContentDiv)) { // Check if pdfContentDiv is defined and exists
                    document.body.removeChild(pdfContentDiv); // Clean up temporary div
                }
            }
        }

        /**
         * Shares a message via WhatsApp after generating the PDF.
         */
        async function shareOnWhatsApp() {
            // First, generate the PDF (this will trigger a download)
            await generatePDF();

            const studentName = document.getElementById('studentName').value.trim();
            const shareText = `السلام علیکم! ${studentName} کا رزلٹ کارڈ تیار ہو گیا ہے۔ براہ کرم اسے اپنے براؤزر کے ڈاؤن لوڈز فولڈر سے دیکھیں۔`;
            const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(shareText)}`;

            // Open WhatsApp in a new tab/window
            window.open(whatsappUrl, '_blank');
            showMessage('واٹس ایپ شیئرنگ کے لیے ایک نیا ٹیب کھل گیا ہے۔', 'info');
        }

        /**
         * Downloads all class data as an Excel file from Firestore.
         */
        async function downloadClassDataAsExcel() {
            if (!window.db || !window.currentUserId) {
                console.error("Firestore or User ID not available.");
                showMessage('ایکسل ڈاؤن لوڈ کے لیے فائر بیس تیار نہیں ہے۔', 'error');
                return;
            }

            const loadingIndicator = document.getElementById('loadingIndicator');
            loadingIndicator.textContent = 'ایکسل فائل تیار کی جا رہی ہے...';
            loadingIndicator.style.display = 'block';
            showMessage('', 'info'); // Clear previous messages

            try {
                const collectionPath = `artifacts/${window.__app_id}/users/${window.currentUserId}/class_results`;
                const q = window.query(window.collection(window.db, collectionPath));
                const querySnapshot = await window.getDocs(q);

                let allStudentData = [];
                // Define fixed headers in the desired order
                const fixedHeaders = [
                    "سکول کا نام", "کلاس کا نام", "کلاس سیکشن", "کلاس انچارج کا نام",
                    "طالب علم کا نام", "رول نمبر", "مجموعی نمبر (حاصل کردہ)", "مجموعی نمبر (کل)",
                    "فیصد", "نتیجہ", "تاریخ"
                ];
                let dynamicSubjectHeaders = new Set(); // To collect unique subject headers

                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    let studentRow = {
                        "سکول کا نام": data.schoolName || '',
                        "کلاس کا نام": data.className || '',
                        "کلاس سیکشن": data.classSection || '',
                        "کلاس انچارج کا نام": data.classIncharge || '',
                        "طالب علم کا نام": data.studentName || '',
                        "رول نمبر": data.rollNumber || '',
                        "مجموعی نمبر (حاصل کردہ)": data.obtainedMarks || 0,
                        "مجموعی نمبر (کل)": data.totalMarks || 0,
                        "فیصد": data.percentage ? `${data.percentage}%` : '0%',
                        "نتیجہ": data.result || '',
                        "تاریخ": data.timestamp ? new Date(data.timestamp.toDate()).toLocaleDateString('ur-PK') : '' // Convert Firestore Timestamp to readable date
                    };

                    // Add subject columns dynamically and collect their headers
                    if (data.subjects && Array.isArray(data.subjects)) {
                        data.subjects.forEach(subject => {
                            const subjectName = subject.name || 'نامعلوم مضمون';
                            const obtained = subject.obtained || 0;
                            const total = subject.total || 0;
                            studentRow[`${subjectName} (حاصل کردہ)`] = obtained;
                            studentRow[`${subjectName} (کل)`] = total;
                            dynamicSubjectHeaders.add(`${subjectName} (حاصل کردہ)`);
                            dynamicSubjectHeaders.add(`${subjectName} (کل)`);
                        });
                    }
                    studentRow["استاد کے ریمارکس"] = data.teacherRemarks || ''; // Add remarks to the row data
                    allStudentData.push(studentRow);
                });

                if (allStudentData.length === 0) {
                    showMessage('ڈاؤن لوڈ کرنے کے لیے کوئی ڈیٹا موجود نہیں ہے۔', 'info');
                    return;
                }

                // Combine fixed headers, sorted dynamic headers, and then remarks
                let finalHeaders = [...fixedHeaders];
                const sortedDynamicSubjectHeaders = Array.from(dynamicSubjectHeaders).sort((a, b) => a.localeCompare(b, 'ur'));
                finalHeaders = finalHeaders.concat(sortedDynamicSubjectHeaders);
                finalHeaders.push("استاد کے ریمارکس"); // Ensure remarks is the very last column

                // Ensure all rows have all headers, filling missing with empty string
                const formattedData = allStudentData.map(row => {
                    const newRow = {};
                    finalHeaders.forEach(header => {
                        newRow[header] = row[header] !== undefined ? row[header] : '';
                    });
                    return newRow;
                });

                const ws = XLSX.utils.json_to_sheet(formattedData, { header: finalHeaders });
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "کلاس رزلٹ");
                XLSX.writeFile(wb, "کلاس_رزلٹ.xlsx");

                showMessage('ایکسل فائل کامیابی سے تیار ہو گئی ہے۔', 'success');

            } catch (error) {
                console.error("Error downloading Excel:", error);
                showMessage('ایکسل فائل تیار کرنے میں خرابی پیش آئی۔', 'error');
            } finally {
                loadingIndicator.style.display = 'none';
            }
        }
    </script>
</body>
</html>
